name: Create Release PR

on:
  push:
    branches: [staging]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: Create staging â†’ main PR
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # staging â†’ main ã®PRãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          PR_COUNT=$(gh pr list --base main --head staging --state open --json number --jq 'length')
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "PR already exists. Skipping creation."
            PR_NUMBER=$(gh pr list --base main --head staging --state open --json number --jq '.[0].number')
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Get commit messages
        id: commits
        if: steps.check-pr.outputs.pr_count == '0'
        run: |
          # mainã¨stagingã®å·®åˆ†ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
          COMMITS=$(git log origin/main..origin/staging --pretty=format:"- %s" --no-merges | head -20)

          # è¤‡æ•°è¡Œã‚’GitHub Outputã«ä¿å­˜
          {
            echo 'commits<<EOF'
            echo "$COMMITS"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check-pr.outputs.pr_count == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # PRã®æœ¬æ–‡ã‚’ä½œæˆ
          PR_BODY=$(cat <<'EOF'
          ## ãƒªãƒªãƒ¼ã‚¹æº–å‚™å®Œäº†

          stagingãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’mainã«ãƒãƒ¼ã‚¸ã—ã¦æœ¬ç•ªç’°å¢ƒã¸ãƒªãƒªãƒ¼ã‚¹ã—ã¾ã™ã€‚

          ### å¤‰æ›´å†…å®¹

          ${{ steps.commits.outputs.commits }}

          ### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼

          ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š

          1. âœ… CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
          2. ğŸš€ æœ¬ç•ªç’°å¢ƒã¸è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
             - Server: https://api.burio16.com
             - Frontend: https://burio16.com

          ### ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

          - [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šéã—ã¦ã„ã‚‹
          - [ ] stagingç’°å¢ƒã§å‹•ä½œç¢ºèªæ¸ˆã¿
          - [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¿…è¦ãªå ´åˆã¯å®Ÿæ–½æ¸ˆã¿
          - [ ] å¿…è¦ã«å¿œã˜ã¦ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’ç¢ºèªæ¸ˆã¿

          ---

          ğŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          EOF
          )

          # PRã‚’ä½œæˆ
          gh pr create \
            --base main \
            --head staging \
            --title "Release: staging â†’ main" \
            --body "$PR_BODY" \
            --label "release"

      - name: PR Summary
        run: |
          if [ "${{ steps.check-pr.outputs.pr_count }}" -gt 0 ]; then
            echo "### PR Already Exists âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "PR #${{ steps.check-pr.outputs.pr_number }} is already open." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View PR: ${{ github.server_url }}/${{ github.repository }}/pull/${{ steps.check-pr.outputs.pr_number }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### PR Created Successfully! ğŸ‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A new release PR (staging â†’ main) has been created." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Review and merge the PR to deploy to production." >> $GITHUB_STEP_SUMMARY
          fi
