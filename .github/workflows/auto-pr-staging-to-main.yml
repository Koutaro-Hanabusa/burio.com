name: Auto PR Staging to Main

on:
  push:
    branches: [staging]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'

concurrency:
  group: auto-pr-staging-to-main
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  create-pr:
    name: Create PR from Staging to Main
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: staging

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already an open PR from staging to main
          EXISTING_PR=$(gh pr list --head staging --base main --state open --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Found existing PR #$EXISTING_PR"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Generate PR body
        if: steps.check-pr.outputs.exists == 'false'
        id: pr-body
        run: |
          # Get the list of commits from staging that are not in main
          COMMITS=$(git log main..staging --pretty=format:"- %s (%h)" --no-merges)

          # Count the number of commits
          COMMIT_COUNT=$(git rev-list --count main..staging)

          # Generate PR body
          cat << EOF > pr_body.txt
          ## Release Staging to Production

          This PR was automatically generated to promote changes from \`staging\` to \`main\`.

          ### Changes Summary

          **Total Commits**: $COMMIT_COUNT

          ### Commit Details

          $COMMITS

          ---

          ### Pre-merge Checklist

          - [ ] All CI checks are passing
          - [ ] Changes have been tested in staging environment
          - [ ] No breaking changes or proper migration plan exists
          - [ ] Documentation has been updated if necessary
          - [ ] Team has been notified of the deployment

          ### Post-merge Actions

          After merging this PR, the following will happen automatically:
          - Production deployment will be triggered via \`deploy.yml\` workflow
          - Server will be deployed to Cloudflare Workers
          - Frontend will be deployed to Cloudflare Pages

          ---

          **Note**: This is an automated PR. Please review all changes carefully before merging.

          **Triggered by**: ${{ github.event.head_commit.message }}
          **Author**: ${{ github.event.head_commit.author.name }}
          **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          EOF

      - name: Create Pull Request
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create the PR
          PR_URL=$(gh pr create \
            --base main \
            --head staging \
            --title "[Auto] Release staging to production" \
            --body-file pr_body.txt \
            --label "automated" \
            --label "release")

          echo "Created PR: $PR_URL"

          # Add comment to PR about CI status
          gh pr comment "$PR_URL" --body "ðŸ¤– **Automated PR Creation**

          Please ensure all CI checks pass before merging. The production deployment will start automatically after merge.

          To merge this PR safely:
          1. Review all changes in the Files changed tab
          2. Ensure all status checks are green
          3. Confirm staging environment is stable
          4. Merge when ready to deploy to production"

      - name: Update existing PR
        if: steps.check-pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ steps.check-pr.outputs.pr_number }}
        run: |
          echo "PR #$PR_NUMBER already exists. Adding update comment..."

          gh pr comment "$PR_NUMBER" --body "ðŸ”„ **Staging Updated**

          New changes have been pushed to \`staging\` branch.

          **Latest commit**: ${{ github.event.head_commit.message }}
          **Author**: ${{ github.event.head_commit.author.name }}
          **Timestamp**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')

          Please review the updated changes before merging."

      - name: Workflow Summary
        run: |
          if [ "${{ steps.check-pr.outputs.exists }}" = "true" ]; then
            echo "### PR Already Exists :information_source:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "An open PR from staging to main already exists (#${{ steps.check-pr.outputs.pr_number }})." >> $GITHUB_STEP_SUMMARY
            echo "A comment with the latest changes has been added to the existing PR." >> $GITHUB_STEP_SUMMARY
          else
            echo "### PR Created Successfully :white_check_mark:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "A new pull request has been created to merge staging into main." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps**:" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the PR" >> $GITHUB_STEP_SUMMARY
            echo "2. Ensure all checks pass" >> $GITHUB_STEP_SUMMARY
            echo "3. Merge when ready to deploy to production" >> $GITHUB_STEP_SUMMARY
          fi
